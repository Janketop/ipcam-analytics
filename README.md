# Аналитика IP-камер (Телефон/Не работает) — Starter (RU)

Готовый стартовый проект: FastAPI (Python), PostgreSQL, Next.js (React).
- Детекция человека/телефона и позы (YOLOv8 + pose)
- События `PHONE_USAGE` и снимки с размытием лица
- MJPEG live-поток с наложенной разметкой (рамки, скелет)
- Дашборд на русском, статистика за 24 часа

## Запуск
```
cp .env.example .env
# укажите RTSP_SOURCES, например:
# RTSP_SOURCES=cam1|rtsp://user:pass@ip:554/stream1
docker compose up --build
```

- API: http://localhost:8000
- Дашборд: http://localhost:3000
- Live MJPEG: http://localhost:8000/stream/<имя_камеры>

### Повторные подключения к RTSP
- Бэкенд автоматически переподключается к камере, если поток не открылся с первой попытки или связь прервалась.
- Интервал между попытками настраивается переменной `RTSP_RECONNECT_DELAY` (по умолчанию 5 секунд).
- Количество допустимых подряд неудачных чтений кадра — `RTSP_MAX_FAILED_READS` (по умолчанию 25), после чего происходит переподключение.

### Как выбрать транспорт (UDP/TCP)
- По умолчанию OpenCV пытается использовать настройки FFMPEG без явного указания транспорта. Для камер в локальной сети это обычно UDP.
- Если поток доступен только по TCP (например, при подключении через интернет), задайте переменную окружения `RTSP_TRANSPORT=tcp` в `.env`.
- При необходимости передать собственные опции FFMPEG задайте `OPENCV_FFMPEG_CAPTURE_OPTIONS`, например: `rtsp_transport;tcp;stimeout;5000000`.

### Как проверять поток вручную
1. На macOS и Linux можно проверить URL из хоста командой `ffplay` или VLC. Если пароль содержит спецсимволы (`!`, `$` и т. п.), окружайте адрес одинарными кавычками или экранируйте символы, иначе оболочка (особенно `zsh`) попытается интерпретировать их как историю команд.
   ```bash
   ffplay 'rtsp://admin:458211Qwe!@192.168.1.37:554/RVI/1/1'
   # или с экранированием
   ffplay rtsp://admin:458211Qwe\!@192.168.1.37:554/RVI/1/1
   ```
2. Чтобы исключить сетевые проблемы Docker, выполните проверку внутри контейнера бэкенда:
   ```bash
   docker compose exec backend bash -lc "ffplay 'rtsp://user:pass@ip:554/stream'"
   ```
   Используем `bash -lc`, чтобы одна пара кавычек попала внутрь контейнера и сохранила URL неизменным.

### Приватность
- Размытие лиц включено по умолчанию (FACE_BLUR=true)
- Хранение снимков ограничено, события в БД
- Вся терминология и UI — на русском
