# Аналитика IP-камер (Телефон/Не работает) — Starter (RU)

Готовый стартовый проект: FastAPI (Python), PostgreSQL, Next.js (React).
- Детекция человека/телефона и позы (YOLOv8 + pose)
- События `PHONE_USAGE` и снимки с размытием лица
- MJPEG live-поток с наложенной разметкой (рамки, скелет)
- Дашборд на русском, статистика за 24 часа

## Запуск
```
cp .env.example .env
# укажите RTSP_SOURCES, например:
# RTSP_SOURCES=cam1|rtsp://user:pass@ip:554/stream1
docker compose up --build
```

- API: http://localhost:8000
- Дашборд: http://localhost:3000
- Live MJPEG: http://localhost:8000/stream/<имя_камеры>

### Повторные подключения к RTSP
- Бэкенд автоматически переподключается к камере, если поток не открылся с первой попытки или связь прервалась.
- Интервал между попытками настраивается переменной `RTSP_RECONNECT_DELAY` (по умолчанию 5 секунд).
- Количество допустимых подряд неудачных чтений кадра — `RTSP_MAX_FAILED_READS` (по умолчанию 25), после чего происходит переподключение.

### Производительность и приватность
- Для ускорения инференса визуализация поверх кадра теперь выключена по умолчанию (`VISUALIZE=false`). Если нужен поток с разметкой, явно включите переменную окружения `VISUALIZE=true`.
- Размытие лиц при сохранении снимков отключено по умолчанию (`FACE_BLUR=false`). Включайте `FACE_BLUR=true`, когда требуется дополнительная защита персональных данных.
- Хранение снимков ограничено, события в БД.
- Вся терминология и UI — на русском.

### Тонкая настройка воркеров
- `YOLO_DET_MODEL` и `YOLO_POSE_MODEL` — задают пути до весов YOLO (можно указать облегчённые/квантизованные варианты).
- `YOLO_DEVICE` — устройство для инференса (`auto`, `cpu`, `cuda:0`, `mps` и т.д.). При значении `auto` сервис сам выберет доступный GPU (CUDA/MPS), иначе вернётся на CPU. Если вы хотите принудительно закрепить конкретную карту, укажите её явно (`YOLO_DEVICE=cuda:0`) и запустите контейнер с доступом к GPU.
- `YOLO_IMAGE_SIZE` — размер входного изображения для обоих проходов YOLO (по умолчанию 640).
- `INGEST_FPS_SKIP` — обрабатывать каждый N-й кадр (по умолчанию 2, то есть половина кадров).
- `INGEST_FLUSH_TIMEOUT` — время (в секундах), в течение которого воркер сбрасывает устаревшие кадры, чтобы взять самый свежий (по умолчанию 0.2).
- `PHONE_SCORE_SMOOTHING` — сколько последних кадров участвует в сглаживании уверенности (по умолчанию 5), помогает не терять короткие детекции.
- `POSE_ONLY_SCORE_THRESHOLD`, `POSE_ONLY_HEAD_RATIO`, `POSE_WRISTS_DIST_RATIO`, `POSE_TILT_THRESHOLD` — параметры позовой эвристики для случаев, когда телефон не детектится напрямую (руки возле головы, запястья близко друг к другу, наклон головы).

Практические советы:
- Если поток перегружает CPU, увеличьте `INGEST_FPS_SKIP` до 3–4 или укажите облегчённые веса (например, INT8) в `YOLO_DET_MODEL`/`YOLO_POSE_MODEL`.
- Чтобы убедиться, что события действительно распознаются, откройте `http://localhost:8000/stream/<имя_камеры>` — при детекции появится подпись `PHONE_USAGE`.
- Логи контейнера `backend` подскажут, если RTSP-поток недоступен или часто обрывается (`docker logs backend`).
